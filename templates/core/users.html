{% extends "core/base.html" %}

{% load static %}
{% block title %}Пользователи{% endblock %}
{% block head %}

<script>
    usernames = [
        {% for user in users %}{name: "{{ user.name }}", rating: {{ user.rating }}}, {% endfor %}
    ];
</script>
{% endblock %}

{% block content %}
<script>
var l4reverSignupTimestamp = 1274536587;
function _l4rverEasterEggTimer() {
    l4reverEasterEgg.getElementsByClassName('value')[0].textContent = parseInt(Date.now() / 1000 - l4reverSignupTimestamp) ;
    setTimeout(_l4rverEasterEggTimer, 1000);
}

function _executeL4reverEasterEgg() {
    l4reverEasterEgg.style = "display: table-row;";
    _l4rverEasterEggTimer();
}

function executeL4reverEasterEgg() {
    setTimeout(_executeL4reverEasterEgg, 30 * 1000);
}

var userSearchOptions = {
  shouldSort: true,
  threshold: 0.6,
  location: 0,
  distance: 100,
  maxPatternLength: 32,
  minMatchCharLength: 1,
  keys: [
    "name",
  ]
};
var usersSearch = new Fuse(usernames, userSearchOptions);

function processSearchTextboxInput(currElement)
{
    console.log(currElement.value);
    users = usersSearch.search(currElement.value);
    searchResultBox.textContent = "";
    for(var i = 0; i < 5 && i < users.length; ++i) {
        userEl = document.createElement('div');
        usernameEl = document.createElement('span');
        usernameEl.textContent = users[i].name;
        ratingEl = document.createElement('span');
        ratingEl.setAttribute('class', 'rating');
        ratingEl.textContent = users[i].rating;

        userEl.appendChild(usernameEl);
        userEl.appendChild(ratingEl);
        userEl.username = users[i].name;
        userEl.onclick = function() { renderUserPage(this.username); };
        searchResultBox.appendChild(userEl);
    }
}

function renderUserPage(username)
{
    searchResultBox.textContent = "";
    searchTextbox.value = "";
    getUserInfo(username, function (response) {
        if (response.error !== undefined) {
            console.log('fuck');
            return;
        }
        user = response;
        getUserGraphs(username, function(response) {
            if (response.error !== undefined) {
                console.log('fuck');
                return;
            }
            graphs = response;
            _renderUserPage(user, graphs.ratingEntries.items,
                            graphs.commentsEntries.items, graphs.postsEntries.items, graphs.hotPostsEntries.items,
                            graphs.minusesEntries.items, graphs.plusesEntries.items, graphs.subscribersEntries.items);
        });
    });
}

function _renderUserPage(user, ratingEntries,
            commentsEntries, postsEntries, hotPostsEntries, minusesEntries, plusesEntries, subscribersEntries)
{
    username = user.username;

    userPage.textContent = "";

    var l4reverEasterEgg = {}

    if (username == 'l4rever') {
        l4reverEasterEgg = {
            tag: 'tr',
            id: 'l4reverEasterEgg',
            className: 'item',
            style: 'display: none',
            content: [
                {
                    tag: 'td',
                    className: 'key',
                    content: 'Секунд',
                },
                {
                    tag: 'td',
                    className: 'value',
                    content: parseInt(Date.now() / 1000 - l4reverSignupTimestamp),
                },
                {
                    tag: 'script',
                    content: 'executeL4reverEasterEgg();',
                },
            ]
        };
    }

    var userInfoDom = {
        tag: 'table',
        className: 'infoBlock',
        content: [
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'Рейтинг',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.rating,
                    },
                ]
            },
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'Комментариев',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.commentsCount,
                    },
                ]
            },
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'Постов',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.postsCount,
                    },
                ]
            },
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'Горячих из них',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.hotPostsCount,
                    },
                ]
            },
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'плюсов',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.plusesCount,
                    },
                ]
            },
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'минусов',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.minusesCount,
                    },
                ]
            },
            {
                tag: 'tr',
                className: 'item',
                content: [
                    {
                        tag: 'td',
                        className: 'key',
                        content: 'подписчиков',
                    },
                    {
                        tag: 'td',
                        className: 'value',
                        content: user.subscribersCount,
                    },
                ]
            },
            l4reverEasterEgg,
        ]
    };
    function makeGraphDom(id, name) {
        dom = {
            id: id,
            content: [
                {
                    tag: 'h3',
                    content: name
                },
                {
                    id: 'chartdiv_' + id,
                    style: 'width: 100%; height: 500px;',
                    content: '',
                },
            ]
        }

        return dom;
    }
    var ratingGraphDom = makeGraphDom('ratingGraphDom', 'рейтинг');
    var commentsGraphDom = makeGraphDom('commentsGraphDom', 'комментарии');
    var postsGraphDom = makeGraphDom('postsGraphDom', 'посты');
    var hotPostsGraphDom = makeGraphDom('hotPostsGraphDom', 'горячие посты');
    var plusesGraphDom = makeGraphDom('plusesGraphDom', 'плюсы');
    var minusesGraphDom = makeGraphDom('minusesGraphDom', 'минусы');
    var subscribersGraphDom = makeGraphDom('subscribersGraphDom', 'подписчики');

    var dom = [
        {
            tag: 'h1',
            className: 'username_h1',
            content: [
                {
                    tag: 'a',
                    title: 'Посмотреть на пикабу',
                    href: 'https://pikabu.ru/profile/' + username,
                    target: '_blank',
                    content: username,
                }
            ],
        },
        userInfoDom,
        ratingGraphDom,
        commentsGraphDom,
        postsGraphDom,
        hotPostsGraphDom,
        plusesGraphDom,
        minusesGraphDom,
        subscribersGraphDom,
    ];
    generateDOM(dom, userPage);


    function renderGraph(graph_id, data) {
        for(var i = 0; i < data.length; ++i) {
            data[i].date = data[i].timestamp * 1000;  // new Date(data[i].timestamp * 1000);
        }

        var chart = AmCharts.makeChart(graph_id, {
            "type": "serial",
            "theme": "light",
            "marginRight": 80,
            "autoMarginOffset": 20,
            "marginTop": 7,
            "dataProvider": data,
            "valueAxes": [{
                /*"axisAlpha": 0.2,
                "dashLength": 1,*/
                "position": "left"
            }],
            "mouseWheelZoomEnabled": false,
            "graphs": [{
                "id": "g1",
                "balloonText": "[[value]]",
                "bullet": "round",
                "bulletBorderAlpha": 1,
                "bulletColor": "#FFFFFF",
                "hideBulletsCount": 50,
                "title": "red line",
                "valueField": "value",
                "useLineColorForBulletBorder": true,
                "balloon":{
                    "drop":true
                }
            }],
            "chartScrollbar": {
                "autoGridCount": true,
                "graph": "g1",
                "scrollbarHeight": 40
            },
            "chartCursor": {
               "limitToGraph":"g1"
            },
            "categoryField": "date",
            "categoryAxis": {
                "minPeriod": "mm",
                "parseDates": true,
                "axisColor": "#DADADA",
                "dashLength": 1,
                "minorGridEnabled": true
            },
            "export": {
                "enabled": true
            }
        });

        chart.addListener("rendered", zoomChart);
        zoomChart();

        // this method is called when chart is first inited as we listen for "rendered" event
        function zoomChart() {
            // different zoom methods can be used - zoomToIndexes, zoomToDates, zoomToCategoryValues
            chart.zoomToIndexes(data.length - 40, data.length - 1);
        }
    }

    renderGraph('chartdiv_ratingGraphDom', ratingEntries);
    renderGraph('chartdiv_commentsGraphDom', commentsEntries);
    renderGraph('chartdiv_postsGraphDom', postsEntries);
    renderGraph('chartdiv_hotPostsGraphDom', hotPostsEntries);
    renderGraph('chartdiv_plusesGraphDom', plusesEntries);
    renderGraph('chartdiv_minusesGraphDom', minusesEntries);
    renderGraph('chartdiv_subscribersGraphDom', subscribersEntries);
}

function showAllUsers()
{
    html = "<table class='popup_table'>";
    for(var i = 0; i < usernames.length; ++i) {
        html += "<tr>";
        html += "<td>" + usernames[i].name + "</td>";
        html += "<td>" + usernames[i].rating + "</td>";
        html += "<td><a href='https://pikabu.ru/profile/" + usernames[i].name + "' target='_blank'>Смотреть на пикабу</a></td>";
        html += "</tr>";
    }
    html += "</table>";
    showPopup(html);
}
</script>

<input id="searchTextbox" placeholder="введи ник пикабушника" type="text" oninput="processSearchTextboxInput(this)">
<div id="searchResultBox">

</div>
<a class="showAllButton" href="#" onclick="showAllUsers()">Посмотреть всех</a>

<div id="userPage">
    <h1><center>Ну же, введи уже что-нибудь в эту форму.</center></h1>
</div>
{% endblock %}